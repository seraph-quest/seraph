# ------------------------------------------------------------------
#         Infrastructure Services (Third-Party)
# ------------------------------------------------------------------
# Defines the core third-party services like databases and message queues.

services:
  backend-dev:
    container_name: backend-dev
    build:
      context: ./backend
      dockerfile: ./Dockerfile
    volumes:
      - ./backend/src:/app/src
      - ./backend/config:/app/config
      - ./backend/tests:/app/tests
      - ./backend/main.py:/app/main.py
      - ./backend/pyproject.toml:/app/pyproject.toml
      - ./backend/uv.lock:/app/uv.lock
      - ${BACKEND_DATA_PATH_DEV}:/app/data
      - ${BACKEND_LOGS_PATH_DEV}:/app/logs
      - ./shared:/app/shared
    env_file:
      - .env.dev
    networks:
      - seraph-network-dev
    ports:
      - "8004:8003" # Non-standard port for dev
    shm_size: "1gb"  # Required for Playwright/Chromium
    depends_on:
      - sandbox-dev

  sandbox-dev:
    container_name: sandbox-dev
    platform: linux/amd64
    image: ghcr.io/python-discord/snekbox:latest
    privileged: true
    ipc: none
    networks:
      - seraph-network-dev
    # No ports exposed â€” backend connects via internal network

  # github-mcp:
  #   container_name: github-mcp
  #   image: ghcr.io/github/github-mcp-server:latest
  #   # TODO: github-mcp-server only supports stdio mode; needs mcp-proxy
  #   # or use GitHub's hosted endpoint at https://api.githubcopilot.com/mcp/
  #   environment:
  #     GITHUB_PERSONAL_ACCESS_TOKEN: ${GITHUB_PERSONAL_ACCESS_TOKEN}
  #     GITHUB_TOOLSETS: ${GITHUB_MCP_TOOLSETS:-repos,issues,pull_requests,code_security}
  #   networks:
  #     - seraph-network-dev
  #   restart: unless-stopped

  frontend-dev:
    container_name: frontend-dev
    build:
      context: ./frontend
      dockerfile: ./Dockerfile
    volumes:
      - ./frontend/src:/app/src
      - ./frontend/public:/app/public
      - ./frontend/index.html:/app/index.html
      - ./frontend/vite.config.ts:/app/vite.config.ts
      - ./frontend/tailwind.config.ts:/app/tailwind.config.ts
      - ./frontend/postcss.config.js:/app/postcss.config.js
      - ./frontend/tsconfig.json:/app/tsconfig.json
      - ./frontend/tsconfig.app.json:/app/tsconfig.app.json
      - ./frontend/tsconfig.node.json:/app/tsconfig.node.json
    env_file:
      - .env.dev
    networks:
      - seraph-network-dev
    ports:
      - "3000:5173"
    depends_on:
      - backend-dev

networks:
  seraph-network-dev:
    name: seraph-network-dev
